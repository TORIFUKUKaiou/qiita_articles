---
title: è¶…ã‚·ãƒ³ãƒ—ãƒ«ï¼ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã®é›»è©±é€£çµ¡ã‚’è‡ªå‹•åŒ–ã—ã¦ã¿ãŸè©± (2025å¹´ç‰ˆ)
tags:
  - Python
  - AWS
  - Gmail
  - whi-advent
  - é—˜é­‚
private: false
updated_at: '2025-11-29T22:17:16+09:00'
id: 8ad537bcb178b75ab87c
organization_url_name: null
slide: false
ignorePublish: false
---
https://qiita.com/advent-calendar/2025/works-hi-2

:::note info
**Qiita Advent Calendar 2025**
ä»Šå¹´ã‚‚ã“ã®å­£ç¯€ãŒã„ã‚ˆã„ã‚ˆå§‹ã¾ã‚Šã¾ã—ãŸ :tada::tada::tada:
èª°ã‚ˆã‚Šã‚‚ã“ã®æ—¥ã‚’å¾…ã¡ã‚ã³ã¦ã„ãŸã¨è‡ªè² ã—ã¦ãŠã‚Šã¾ã™ã€‚

2024å¹´12æœˆ26æ—¥ã‹ã‚‰é¦–ã‚’é•·ãã—ã¦æ¥½ã—ã¿ã«ã—ã¦ãŠã‚Šã¾ã—ãŸã€‚
:xmas-wreath1::santa::santa_tone1::santa_tone2::santa_tone3::santa_tone4::santa_tone5: :xmas-tree::xmas-wreath2:
:qiitan::qiitan::qiitan::qiitan::qiitan::qiitan::qiitan::qiitan::qiitan::qiitan::qiitan:
:::

## ã¯ã˜ã‚ã«
ã“ã®è¨˜äº‹ã¯ã€Works Human Intelligenceã‚µãƒ³ã‚¿ :santa: æ§˜ã®ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆğŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ :calendar: ã€Œ[ã€Œãƒ¬ã‚¬ã‚·ãƒ¼ã€ã‚’ä¿å®ˆã—ãŸã‚Šã€åˆ·æ–°ã—ãŸã‚Šã™ã‚‹ã«ã‚ãŸã‚Šå¾—ã‚‰ã‚ŒãŸçŸ¥è¦‹ãƒ»ãƒã‚¦ãƒã‚¦ãƒ»è‹¦åŠ´è©± by Works Human Intelligence Advent Calendar 2025](https://qiita.com/advent-calendar/2025/works-hi-2)ã€ã¸ã®å¿œå‹Ÿè¨˜äº‹ã§ã™ã€‚

æ˜¨å¹´ã‚‚ä¸‹è¨˜ã®è¨˜äº‹ã‚’å¿œå‹Ÿã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

https://qiita.com/torifukukaiou/items/0a65efe197fc4e15577a

ä»Šå¹´ã¯ãã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ãŠå±Šã‘ã—ã¾ã™ã€‚

ãã‚Œã§ã¯ã¾ãšã€ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹æ˜¨å¹´ã®è¨˜äº‹ã‹ã‚‰ã®æŒ¯ã‚Šè¿”ã‚Šã§ã™ã€‚

## å•é¡Œç‚¹ã¨ãã®è§£æ±ºç­–
ã¾ãšã€å•é¡Œç‚¹ã¨ãã®è§£æ±ºç­–ã‚’ç¤ºã—ã¾ã™ã€‚

### beforeï¼ˆå•é¡Œç‚¹ï¼‰
ç§ãŒæ‰€å±ã™ã‚‹[ãƒã‚¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒŠã‚·ãƒ§ãƒŠãƒ«](https://www.haw.co.jp/)ã¯ã€ãƒ•ãƒ«ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯ã‚’å®Ÿç¾ã—ã¦ã„ã‚‹ä¼šç¤¾ã§ã™ã€‚æœ¬ç¤¾ã¯ç¦å²¡çœŒé£¯å¡šå¸‚ã«ã‚ã‚Šã¾ã™ãŒã€æ±äº¬ã€æ„›çŸ¥ã€æ²–ç¸„ã€ã•ã‚‰ã«ã¯ã€Œé—˜é­‚ã®å›½ã€ã‹ã‚‰ã‚‚ãƒ¡ãƒ³ãƒãƒ¼ãŒåƒã„ã¦ã„ã¾ã™ã€‚ã“ã®åˆ†æ•£ã—ãŸãƒãƒ¼ãƒ ç’°å¢ƒã«ãŠã„ã¦ã€é›»è©±å¯¾å¿œã‚’ã©ã®ã‚ˆã†ã«åŠ¹ç‡åŒ–ã™ã‚‹ã‹ãŒå¤§ããªèª²é¡Œã§ã—ãŸã€‚

é›»è©±å¯¾å¿œã®æµã‚Œã¯æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ã§ã—ãŸï¼š

1. [é›»è©±ä»£è¡Œã‚µãƒ¼ãƒ“ã‚¹](https://denwadaikou.jp/)ãŒå—ã‘ãŸé›»è©±ã®å†…å®¹ï¼ˆèª°ã‹ã‚‰èª°ã¸ã®é›»è©±ã ã£ãŸã®ã‹ï¼‰ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡
1. ãƒ¡ãƒ¼ãƒ«ã‚’å—ã‘å–ã£ãŸæ‹…å½“è€…ãŒå†…å®¹ã‚’ç¢ºèª
1. Slackã§è©²å½“è€…ã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã¦é€£çµ¡

ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«è¦‹ãˆã¾ã™ãŒã€å›³ä¸­ã®ã€Œæ‹…å½“è€…ã€ã®æ‰‹å‹•ã®ä½œæ¥­ãŒèª²é¡Œã§ã—ãŸã€‚é›»è©±ã¯ã™ãã«å–ã‚Šæ¬¡ãã®ãŒé‰„å‰‡ã§ã™ã‹ã‚‰ã€ãã‚Œã¾ã§ã—ã¦ã„ãŸä½œæ¥­ã‚’ä¸€æ™‚ä¸­æ–­ã—ã¦ã€æ‹…å½“è€…ã¸ã®é€£çµ¡ã‚’å„ªå…ˆã›ã­ã°ãªã‚Šã¾ã›ã‚“ã€‚æƒ³åƒã«é›£ããªã„é€šã‚Šã€ã€Œæ‹…å½“è€…ã€ã®è² æ‹…ã¯å®Ÿã¯ç›¸å½“ãªã‚‚ã®ã§ã™ã€‚

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/131808/7d32a0ee-4d1d-46e6-9c41-85217d2beb88.png)


### afterï¼ˆè§£æ±ºç­–ï¼‰
ç§ã¯ã“ã®æ‰‹å‹•ãƒ—ãƒ­ã‚»ã‚¹ã®ã€Œ2ç•ªã¨3ç•ªã€ã‚’è‡ªå‹•åŒ–ã™ã‚‹ã“ã¨ã«æŒ‘æˆ¦ã—ã¾ã—ãŸã€‚ãã®çµæœã€æ–°ã—ã„ãƒ•ãƒ­ãƒ¼ã¯æ¬¡ã®ã‚ˆã†ã«æ”¹å–„ã•ã‚Œã¾ã—ãŸï¼š

1. é›»è©±ä»£è¡Œã‚µãƒ¼ãƒ“ã‚¹ãŒé›»è©±ã®å†…å®¹ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡
1. **ãƒœãƒƒãƒˆ**ãŒã€ãã®ãƒ¡ãƒ¼ãƒ«ã‚’è§£æã—ã€Slackã§è©²å½“ã™ã‚‹æ‹…å½“è€…ã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã¦é›»è©±ãŒã‚ã£ãŸã“ã¨ã‚’è‡ªå‹•é€šçŸ¥

ãŸã£ãŸã“ã‚Œã ã‘ã®æ”¹å–„ã§ã™ãŒã€æ¥­å‹™åŠ¹ç‡ã¯æ ¼æ®µã«å‘ä¸Šã—ã¾ã—ãŸã€‚

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/131808/5b73b35d-eef6-ff4f-7472-533dfe4b6911.png)

æ‹…å½“è€…ã¯ã€ãƒªãƒ³ãƒœãƒ¼ãƒ€ãƒ³ã‚¹ã‚’ã¯ã˜ã‚ã¾ã—ãŸï¼
ãƒªãƒ³ãƒœãƒ¼ãƒ€ãƒ³ã‚¹ã¯å¤§ã’ã•ã§ã™ãŒã€é›»è©±å¿œå¯¾ã§ä½œæ¥­ã‚’ä¸­æ–­ã™ã‚‹å¿…è¦ãŒãªããªã‚Šã€ãã®åˆ†ä»–ã®ã‚¿ã‚¹ã‚¯ã«é›†ä¸­ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã¨ã„ã†ã“ã¨ã‚’è¨€ã„ãŸã„ã‚ã‘ã§ã™ã€‚

æ˜¨å¹´ã®è¨˜äº‹ã®æŒ¯ã‚Šè¿”ã‚Šã¯ä»¥ä¸Šã§ã™ã€‚ãã‚Œã§ã¯ã„ã‚ˆã„ã‚ˆæœ¬é¡Œã¸ã¨å…¥ã‚Šã¾ã™ã€‚

---

## ä»Šå¹´ã¯ä½•ã‚’å¤‰ãˆãŸã®?
ä»Šå¹´ã¯ä»¥ä¸‹ã‚’å¤‰ãˆã¾ã—ãŸã€‚
- 1. Ruby => Pythonã¸ç½®ãæ›ãˆ
- 2. EC2ã®cronå®Ÿè¡Œ => [AWS Lambda](https://aws.amazon.com/jp/pm/lambda/)ã¨[Amazon EventBrige](https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-what-is.html)ã§å®šæœŸå®Ÿè¡Œ
- 3. æ‰‹ä½œæ¥­ã®AWSãƒªã‚½ãƒ¼ã‚¹æ§‹ç¯‰ã‚’[AWS CDK](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/home.html)ã§æ§‹ç¯‰

ä»Šå¹´ã¯ã€ã“ã®ä»•çµ„ã¿ãŒå¤§å¤‰é©ã‚’é‚ã’ãŸå¹´ã«ãªã‚Šã¾ã—ãŸã€‚
ä»¥ä¸‹ã€ã²ã¨ã¤ã²ã¨ã¤ã¿ã¦ã„ãã¾ã™ã€‚

### 1. Ruby => Pythonã¸ç½®ãæ›ãˆ
ä»¥å‰ã¯å­˜åœ¨ã—ãŸ https://developers.google.com/gmail/api/quickstart/ruby ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ https://developers.google.com/workspace/gmail/api/quickstart/js?hl=ja ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚
ç§ã¯ãªã«ã›ã€ã€Œ[Elixirå®Ÿè·µå…¥é–€ | æŠ€è¡“è©•è«–ç¤¾](https://gihyo.jp/book/2024/978-4-297-14014-4)ã€ã®è‘—è€…é™£ã®æœ«å¸­ã‚’æ±šã™ã‚‚ã®ãªã®ã§ã€ElixirãŒä¸€ç•ªå¾—æ„ã ã¨è‡ªè² ã—ã¦ãŠã‚Šã¾ã™ã€‚JavaScriptã¯é›°å›²æ°—ã§æ°—æŒã¡ã€ãªã‚“ã¨ãªãã‚ã‹ã‚‰ãªã„ã‚ã‘ã§ã¯ãªã„ã—ã€ç”ŸæˆAIã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ã®åŠ›ã‚’å€Ÿã‚Šã‚Œã°ãªã‚“ã¨ã‹ãªã‚Šãã†ã§ã™ãŒã€JavaScriptã‚ˆã‚Šã¯è‡ªä¿¡ã®ã‚ã‚‹Pythonã‚’é¸ã³ã¾ã—ãŸã€‚å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç‰‡æ‰‹ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚[AWS Lambda](https://aws.amazon.com/jp/pm/lambda/)ã§å‹•ã‹ã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æƒœã—ã’ã‚‚ãªãå…¬é–‹ã—ã¦ãŠãã¾ã™ã€‚

#### 1-1. Gmailã‚’å—ä¿¡ã™ã‚‹ã‚³ãƒ¼ãƒ‰

ã¾ãšã¯Gmailã‚’å—ä¿¡ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚æ°¸ç¶šåŒ–ã—ã¦ãŠããŸã„æƒ…å ±ã¯ã€[AWS Systems Manager Parameter Store](https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/systems-manager-parameter-store.html)ã«ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚

<details><summary>awesome_gmail.py</summary>

```python:awesome_gmail.py
import os
import base64
import json
import boto3
from google.auth.transport.requests import Request
from google.oauth2.credentials import Credentials
from google_auth_oauthlib.flow import InstalledAppFlow
from googleapiclient.discovery import build

# Constants
ENVIRONMENT = os.getenv('ENVIRONMENT', 'local')  # 'local' or 'aws'
CREDENTIALS_PATH = "credentials.json"
TOKEN_PATH = "token.json"
CREDENTIALS_PARAM = "/gmail_to_slack/credentials"
TOKEN_PARAM = "/gmail_to_slack/token"
SCOPES = ['https://www.googleapis.com/auth/gmail.readonly']
MAX_RESULTS = 20


class AwesomeGmail:
    @staticmethod
    def get_credentials():
        """Retrieve credentials.json content based on environment."""
        if ENVIRONMENT == 'local':
            with open(CREDENTIALS_PATH, 'r') as f:
                return json.load(f)
        elif ENVIRONMENT == 'aws':
            ssm = boto3.client('ssm')
            response = ssm.get_parameter(Name=CREDENTIALS_PARAM, WithDecryption=True)
            return json.loads(response['Parameter']['Value'])

    @staticmethod
    def get_token():
        """Retrieve token.json content based on environment."""
        if ENVIRONMENT == 'local':
            if os.path.exists(TOKEN_PATH):
                with open(TOKEN_PATH, 'r') as f:
                    return json.load(f)
            return None
        elif ENVIRONMENT == 'aws':
            ssm = boto3.client('ssm')
            try:
                response = ssm.get_parameter(Name=TOKEN_PARAM, WithDecryption=True)
                return json.loads(response['Parameter']['Value'])
            except ssm.exceptions.ParameterNotFound:
                return None

    @staticmethod
    def save_token(token):
        """Save token.json content based on environment."""
        if ENVIRONMENT == 'local':
            with open(TOKEN_PATH, 'w') as f:
                json.dump(token, f)
        elif ENVIRONMENT == 'aws':
            ssm = boto3.client('ssm')
            ssm.put_parameter(
                Name=TOKEN_PARAM,
                Value=json.dumps(token),
                Type='SecureString',
                Overwrite=True
            )

    @staticmethod
    def authorize():
        """Authorize and return Gmail service credentials."""
        creds = None

        # Retrieve token
        token_data = AwesomeGmail.get_token()
        if token_data:
            creds = Credentials.from_authorized_user_info(token_data, SCOPES)

        # If there are no (valid) credentials available, let the user log in.
        if not creds or not creds.valid:
            if creds and creds.expired and creds.refresh_token:
                creds.refresh(Request())
            else:
                credentials_data = AwesomeGmail.get_credentials()
                flow = InstalledAppFlow.from_client_config(credentials_data, SCOPES)
                creds = flow.run_local_server(port=0)

            # Save the credentials for the next run
            AwesomeGmail.save_token(json.loads(creds.to_json()))  # Use to_json and convert to dict

        return creds

    @staticmethod
    def list():
        """List Gmail message IDs."""
        creds = AwesomeGmail.authorize()
        service = build('gmail', 'v1', credentials=creds)

        messages = []
        next_page_token = None

        query = f"from:{os.getenv('GMAIL_TO_SLACK_FROM', '')}"

        while len(messages) < MAX_RESULTS:
            result = service.users().messages().list(
                userId='me',
                maxResults=MAX_RESULTS,
                pageToken=next_page_token,
                q=query
            ).execute()

            if 'messages' in result:
                messages.extend(result['messages'])

            next_page_token = result.get('nextPageToken')
            if not next_page_token or len(messages) >= MAX_RESULTS:
                break

        return [msg['id'] for msg in messages]

    @staticmethod
    def get(message_id):
        """Get a specific Gmail message by ID."""
        creds = AwesomeGmail.authorize()
        service = build('gmail', 'v1', credentials=creds)

        result = service.users().messages().get(
            userId='me',
            id=message_id,
            format='full'
        ).execute()

        payload = result.get('payload', {})
        headers = payload.get('headers', [])

        # Extract header values
        def get_header_value(header_name):
            for header in headers:
                if header['name'].lower() == header_name.lower():
                    return header['value']
            return ''

        date = get_header_value('Date')
        from_addr = get_header_value('From')
        to_addr = get_header_value('To')
        subject = get_header_value('Subject')

        # Extract body
        parts = payload.get('parts', [])
        body_data = payload.get('body', {}).get('data')
        if not body_data and parts:
            body_data = ''.join(part.get('body', {}).get('data', '') for part in parts)

        try:
            body = base64.urlsafe_b64decode(body_data.encode()).decode('utf-8') if body_data else ''
        except Exception:
            body = ''

        return {
            'id': result['id'],
            'date': date,
            'from': from_addr,
            'to': to_addr,
            'subject': subject,
            'body': body
        }

if __name__ == '__main__':
    ids = AwesomeGmail.list()
    for id in ids:
        message = AwesomeGmail.get(id)
        print(message)
```
</details>

ãã‚Œã§ã“ã®è¨˜äº‹ã‚’æ›¸ã„ã¦ã„ã‚‹é€”ä¸­ã§æ€ã„å‡ºã—ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãŸã—ã‹Ruby => Pythonã®ç½®ãæ›ãˆã¯ã€ã©ã‚Œã‚’åˆ©ç”¨ã—ãŸã®ã‹ã¯å¿˜ã‚Œã¾ã—ãŸãŒã€ç”ŸæˆAIã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ„ãƒ¼ãƒ«ã«å¤§éƒ¨åˆ†ã‚’ä½œã£ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚ãŸã¶ã‚“ã€ã“ã‚Œã¯6æœˆãã‚‰ã„ã®ä½œæ¥­ï¼ˆæ€ã„å‡ºï¼‰ãªã®ã§ç§ã¯ãã®ã“ã‚ã¯ã€[GitHub Copilot](https://github.com/features/copilot?locale=ja)ã‚’ã‚ˆãåˆ©ç”¨ã•ã›ã¦ã„ãŸã ã„ã¦ã„ãŸã¨æ€ã„ã¾ã™ã€‚ã„ã¾ã¯å¥½ã¿ãŒã‹ã‚ã£ã¦ã€[Kiro CL((æ—§Amazon Q Developer CLI)](https://kiro.dev/cli/)ã‚’ã‚ˆãåˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚ä½™è«‡ã§ã™ã€‚

#### 1-2. Slackã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ã’è¾¼ã‚€ã‚³ãƒ¼ãƒ‰
Slackã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ã’è¾¼ã‚€ã‚³ãƒ¼ãƒ‰ã‚’ç¤ºã—ã¾ã™ã€‚[Incoming Webhook](https://docs.slack.dev/tools/java-slack-sdk/ja-jp/guides/incoming-webhooks/)ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

<details><summary>awesome_slack.py</summary>

```python:awesome_slack.py
import os
import json
import requests

URL = os.getenv('GMAIL_TO_SLACK_WEB_HOOK_URL')
CHANNEL = os.getenv('GMAIL_TO_SLACK_CHANNEL')

class AwesomeSlack:
    @staticmethod
    def post(text):
        """Send a message to Slack."""
        payload = {
            "text": text,
            "channel": CHANNEL,
            "username": "awesome_bot",
            "icon_emoji": ":telephone:",
            "link_names": 1
        }
        
        headers = {
            "Content-Type": "application/json"
        }
        
        response = requests.post(URL, data=json.dumps(payload), headers=headers)
        
        if response.status_code != 200:
            raise Exception(f"Slack API error: {response.status_code}, {response.text}")
```
</details>

#### 1-3. mainå‡¦ç†
mainã®å‡¦ç†ã‚’ç¤ºã—ã¾ã™ã€‚ `lambda_handler` é–¢æ•°ãŒã€[AWS Lambda](https://aws.amazon.com/jp/pm/lambda/)ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

<details><summary>main.py</summary>

```python:main.py
import os
import boto3
from datetime import datetime, timedelta, timezone
from awesome_gmail import AwesomeGmail
from awesome_slack import AwesomeSlack
from users import USERS

ENVIRONMENT = os.getenv('ENVIRONMENT', 'local')  # 'local' or 'aws'
LAST_AT_LOCAL = 'last_at'
LAST_AT_PARAM = '/gmail_to_slack/last_at'
FROM = os.getenv('GMAIL_TO_SLACK_FROM')

def get_last_at():
    """Retrieve the last processed time."""
    if ENVIRONMENT == 'local':
        if os.path.exists(LAST_AT_LOCAL):
            with open(LAST_AT_LOCAL, 'r') as f:
                return datetime.strptime(f.read().strip(), '%a, %d %b %Y %H:%M:%S %z')
        else:
            return datetime.now(timezone.utc) - timedelta(minutes=5)
    elif ENVIRONMENT == 'aws':
        ssm = boto3.client('ssm')
        try:
            response = ssm.get_parameter(Name=LAST_AT_PARAM)
            return datetime.strptime(response['Parameter']['Value'], '%a, %d %b %Y %H:%M:%S %z')
        except ssm.exceptions.ParameterNotFound:
            return datetime.now(timezone.utc) - timedelta(minutes=5)

def update_last_at(last_at):
    """Update the last processed time."""
    if ENVIRONMENT == 'local':
        with open(LAST_AT_LOCAL, 'w') as f:
            f.write(last_at.strftime('%a, %d %b %Y %H:%M:%S %z'))
    elif ENVIRONMENT == 'aws':
        ssm = boto3.client('ssm')
        ssm.put_parameter(
            Name=LAST_AT_PARAM,
            Value=last_at.strftime('%a, %d %b %Y %H:%M:%S %z'),
            Type='String',
            Overwrite=True
        )

def lambda_handler(event, context):
    """AWS Lambda entry point."""
    # Read the last processed time
    last_at = get_last_at()

    # Fetch and filter emails
    ids = AwesomeGmail.list()
    filtered = []
    for msg_id in ids:
        mail = AwesomeGmail.get(msg_id)
        if FROM in mail.get('from', ''):
            try:
                # Remove "(UTC)" from the date string
                mail_date_str = mail.get('date', '').replace(' (UTC)', '')
                mail_date = datetime.strptime(mail_date_str, '%a, %d %b %Y %H:%M:%S %z')
                if mail_date > last_at:
                    filtered.append(mail)
            except ValueError as e:
                print(f"[WARN] Could not parse date: {mail.get('date')} | From: {mail.get('from')} | Subject: {mail.get('subject')}")
                continue

    # Process filtered emails
    for mail in filtered:
        body = mail['body']
        usernames = {username for key, username in USERS.items() if key in body}

        text = ' '.join(usernames) + "\n" + body
        AwesomeSlack.post(text)
        print(f"Posted to Slack: {mail['date']}, {mail['from']}, {mail['subject']}, {text.replace('\n', ' ')}")

    # Update the last processed time
    if filtered:
        last_mail = max(filtered, key=lambda mail: datetime.strptime(mail['date'], '%a, %d %b %Y %H:%M:%S %z'))
        update_last_at(datetime.strptime(last_mail['date'], '%a, %d %b %Y %H:%M:%S %z'))

    return {
        "statusCode": 200,
        "body": f"Processed {len(filtered)} emails."
    }

if __name__ == '__main__':
    lambda_handler(None, None)
```
</details>

ã“ã“ã§ã‚‚ã€æ°¸ç¶šåŒ–ã—ã¦ãŠããŸã„æƒ…å ±ã¯ã€[AWS Systems Manager Parameter Store](https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/systems-manager-parameter-store.html)ã«ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚
`USERS`ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¾æ›¸å‹ã®ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚

```python:users.py
USERS = {
    "å±±å†…": "@awesome",
    "ã‚„ã¾ã†ã¡": "@awesome",
    "ãƒ¤ãƒã‚¦ãƒ": "@awesome",
}
```

### 2. EC2ã®cronå®Ÿè¡Œ => [AWS Lambda](https://aws.amazon.com/jp/pm/lambda/)ã¨[Amazon EventBrige](https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-what-is.html)ã§å®šæœŸå®Ÿè¡Œ
ä»¥å‰ã¯EC2ã§å‹•ã‹ã—ã¦ã„ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã«ç›®è¦šã‚ãŸã®ã§ã€[AWS Lambda](https://aws.amazon.com/jp/pm/lambda/)ã¨[Amazon EventBrige](https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-what-is.html)ã§å®šæœŸå®Ÿè¡Œã‚’ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šåˆ©ç”¨æ–™é‡‘ã¯å¤§å¹…ã«æŠ‘ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

### 3. æ‰‹ä½œæ¥­ã®AWSãƒªã‚½ãƒ¼ã‚¹æ§‹ç¯‰ã‚’[AWS CDK](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/home.html)ã§æ§‹ç¯‰
ã“ã‚Œã¾ã§ã€AWSã§ãƒªã‚½ãƒ¼ã‚¹æ§‹ç¯‰ã‚’ã™ã‚‹éš›ã«ã¯ã‚‚ã£ã±ã‚‰æ‰‹ä½œæ¥­ãŒãƒ¡ã‚¤ãƒ³ã§ã—ãŸã€‚ç§ã¯ã€‚è‡ªæ…¢ã§ãã‚‹ã“ã¨ã§ã¯ãªãã€ãŠæ¥ãšã‹ã—ã„é™ã‚Šã§ã™ã€‚ä»Šå¹´ã¯çªå¦‚ã€[AWS CDK](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/home.html)ã«ç›®è¦šã‚ã¾ã—ãŸã€‚ã“ã®è¨˜äº‹ã‚’æ›¸ã„ãŸæ™‚ç‚¹ã§ã¯ã€[GitHub Copilot](https://github.com/features/copilot?locale=ja)ã‚’ãªã ã‚ã™ã‹ã—ã¦ãŒã‚“ã°ã£ã¦æ›¸ã„ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚ã„ã¾ã¯ã€[Kiro CL((æ—§Amazon Q Developer CLI)](https://kiro.dev/cli/)ã‚’ã‚ˆãåˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚é–‹çœ¼ã—ã¾ã—ãŸã€‚

ã“ã®ä¸€å¤§å¤‰åŒ–ã¯ã€æ•™è‚²æ©Ÿé–¢ã‚„ä¼æ¥­ã€ç¤¾ä¼šäººã«AWSã‚’æ•™ãˆã•ã›ã¦ã„ãŸã ãã¨ã„ã†çµŒé¨“ãŒç¶šã„ãŸã“ã¨ã¨ã¯ç„¡é–¢ä¿‚ã§ã¯ãªã„ã¨æ€ã„ã¾ã™ã€‚ä¸€ç•ªå­¦ã°ã›ã¦ã„ãŸã ã„ãŸã®ã¯ç§ã ã£ãŸã®ã ã¨æ€ã„ã¾ã™ã€‚ãã®æ©Ÿä¼šã‚’å¾—ã‚‰ã‚ŒãŸã“ã¨ã«æ„Ÿè¬ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚

éš ã™ã»ã©ã®å†…å®¹ã¯ãªã«ã‚‚ãªã„ã®ã§ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãŠæŠ«éœ²ç›®ã—ã¦ãŠãã¾ã™ã€‚2ã®å†…å®¹ï¼ˆã€Œ[AWS Lambda](https://aws.amazon.com/jp/pm/lambda/)ã¨[Amazon EventBrige](https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-what-is.html)ã§å®šæœŸå®Ÿè¡Œã€ï¼‰ã‚’åŒ…å«ã—ã¦ã„ã¾ã™ã€‚

<details><summary>main.py</summary>

```typescript:gmail-to-slack-stack.ts
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { PythonFunction } from '@aws-cdk/aws-lambda-python-alpha';
// import * as sqs from 'aws-cdk-lib/aws-sqs';
import * as lambda from 'aws-cdk-lib/aws-lambda';
import * as logs from 'aws-cdk-lib/aws-logs';
import * as events from 'aws-cdk-lib/aws-events';
import * as targets from 'aws-cdk-lib/aws-events-targets';
import * as iam from 'aws-cdk-lib/aws-iam';
import * as path from 'path';
import * as sns from 'aws-cdk-lib/aws-sns';
import * as subscriptions from 'aws-cdk-lib/aws-sns-subscriptions';
import * as cloudwatch from 'aws-cdk-lib/aws-cloudwatch';
import * as cloudwatch_actions from 'aws-cdk-lib/aws-cloudwatch-actions';

export class GmailToSlackStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // The code that defines your stack goes here

    // example resource
    // const queue = new sqs.Queue(this, 'GmailToSlackQueue', {
    //   visibilityTimeout: cdk.Duration.seconds(300)
    // });

    // Lambdaé–¢æ•°ã®å®šç¾©
    const gmailToSlackLambda = new PythonFunction(this, 'GmailToSlackLambda', {
      runtime: lambda.Runtime.PYTHON_3_13,
      index: 'main.py',
      handler: 'lambda_handler',
      entry: path.join(__dirname, '../lambda'), // main.pyãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š
      logRetention: logs.RetentionDays.ONE_WEEK, // CloudWatch Logsã®ä¿å­˜æœŸé–“ã‚’7æ—¥é–“ã«è¨­å®š
      timeout: cdk.Duration.seconds(60),
      memorySize: 160,
      environment: {
        GMAIL_TO_SLACK_FROM: process.env.GMAIL_TO_SLACK_FROM || 'torifuku.kaiou@gmail.com',
        GMAIL_TO_SLACK_WEB_HOOK_URL: process.env.GMAIL_TO_SLACK_WEB_HOOK_URL || '',
        GMAIL_TO_SLACK_CHANNEL: process.env.GMAIL_TO_SLACK_CHANNEL || '#times_yamauchi',
        ENVIRONMENT: process.env.ENVIRONMENT || 'aws',
      },
    });

    // SSMã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ä»˜ä¸
    const ssmRunCmdPolicy = new iam.PolicyStatement({
      actions: ['ssm:GetParameter', 'ssm:PutParameter'],
      effect: iam.Effect.ALLOW,
      resources: [
        'arn:aws:ssm:*:*:parameter/gmail_to_slack/last_at',
        'arn:aws:ssm:*:*:parameter/gmail_to_slack/credentials',
        'arn:aws:ssm:*:*:parameter/gmail_to_slack/token',
      ],
    });

    const lambdaRole = gmailToSlackLambda.role as iam.Role;
    lambdaRole.addToPolicy(ssmRunCmdPolicy);

    // æœˆæ›œã‹ã‚‰é‡‘æ›œã®8:00-19:00(JST)ã®é–“ã¯1åˆ†ã”ã¨ã«å®Ÿè¡Œ
    const weekdayRule = new events.Rule(this, 'WeekdayScheduleRule', {
      schedule: events.Schedule.cron({
        minute: '0-59',          // æ¯åˆ†
        hour: '23-9',            // UTCã§23:00ã€œ09:59 â†’ JSTã§8:00ã€œ18:59
        weekDay: 'MON-FRI',      // JSTã®æœˆã€œé‡‘ = UTCã®æœˆã€œé‡‘
      }),
    });

    weekdayRule.addTarget(new targets.LambdaFunction(gmailToSlackLambda));

    // ãã‚Œä»¥å¤–ã®æ™‚é–“å¸¯ã§ã¯5åˆ†ã”ã¨ã«å®Ÿè¡Œ
    const offHoursRule = new events.Rule(this, 'OffHoursScheduleRule', {
      schedule: events.Schedule.cron({
        minute: '0/5',           // 5åˆ†ã”ã¨
        hour: '0-22,10-23',      // JSTã®19:00ã€œ7:59 ã«å¯¾å¿œã™ã‚‹UTCæ™‚é–“
        weekDay: '*',            // æ¯æ—¥
      }),
    });

    offHoursRule.addTarget(new targets.LambdaFunction(gmailToSlackLambda));

    // SNSãƒˆãƒ”ãƒƒã‚¯ã®ä½œæˆ
    const errorNotificationTopic = new sns.Topic(this, 'ErrorNotificationTopic', {
      displayName: 'Lambda Error Notifications',
    });

    // SNSãƒˆãƒ”ãƒƒã‚¯ã«ãƒ¡ãƒ¼ãƒ«ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
    errorNotificationTopic.addSubscription(
      new subscriptions.EmailSubscription('yamauchi@haw.co.jp')
    );

    // CloudWatchã‚¢ãƒ©ãƒ¼ãƒ ã®ä½œæˆ
    const lambdaErrorAlarm = new cloudwatch.Alarm(this, 'LambdaErrorAlarm', {
      metric: gmailToSlackLambda.metricErrors(), // Lambdaé–¢æ•°ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹
      threshold: 1, // ã‚¨ãƒ©ãƒ¼ãŒ1å›ä»¥ä¸Šç™ºç”Ÿã—ãŸå ´åˆã«ã‚¢ãƒ©ãƒ¼ãƒ ã‚’ç™ºå‹•
      evaluationPeriods: 1, // 1ã¤ã®è©•ä¾¡æœŸé–“ã§ã‚¢ãƒ©ãƒ¼ãƒ ã‚’ç™ºå‹•
      alarmDescription: 'Alarm for Lambda function errors',
    });

    lambdaErrorAlarm.addAlarmAction(new cloudwatch_actions.SnsAction(errorNotificationTopic));
  }
}
```
</details>

---


## ã•ã„ã”ã«
> é›»è©±ä»£è¡Œã‚µãƒ¼ãƒ“ã‚¹ã®ä¼šç¤¾ã«ã€Œ[Slack ã‚³ãƒã‚¯ãƒˆ](https://slack.com/intl/ja-jp/connect)ã€ã§Slackã«å‚åŠ ã—ã¦ã‚‚ã‚‰ãˆã°ã„ã„ã®ã§ã¯ãªã„ã‹?

ãã€ããƒƒã€ãã£ã€ãã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ :sweat: ãã‚ŒãŒã§ãã‚‹ã®ãªã‚‰ä¸€ç•ªåŠ¹ç‡çš„ã§ã™ã€‚ãã£ã¨ã€åœ°çƒãƒ¬ãƒ™ãƒ«ã§ã¿ãŸã¨ãã«ã¯é›»åŠ›æ¶ˆè²»ã‚’ã‚‚ã£ã¨ã‚‚å°‘ãªãã™ã‚‹è§£æ±ºç­–ã ã¨æ€ã„ã¾ã™ã®ã§ã€ã„ãšã‚Œã¯é™ã‚Šã‚ã‚‹è³‡æºã‚’æœ‰åŠ¹æ´»ç”¨ã™ã‚‹ã¨ã„ã†åœ°çƒãƒ¬ãƒ™ãƒ«ã®è¦³ç‚¹ã§ã¯ãã†ã™ã¹ãã ã¨æ€ã„ã¾ã™ã€‚
ãŸã ã€é›»è©±ä»£è¡Œã‚’ã™ã‚‹ä¼šç¤¾ã®ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹ã«ã‹ã‹ã‚ã‚‹ã“ã¨ãªã®ã§ã€ç§ãŒã‚ã‚Œã“ã‚Œè¨€ãˆãªã„ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã—ã€æ‹…å½“è€…ã®æ¥­å‹™è² è·ã‚’è»½æ¸›ã—ãŸã“ã¨ã‚‚äº‹å®Ÿã§ã™ã€‚ãã—ã¦ã€ãƒ¢ãƒ€ãƒ³ã«[AWS CDK](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/home.html)ã§æ§‹ç¯‰ã™ã‚‹æ©Ÿä¼šã‚’å¾—ã‚‰ã‚ŒãŸã“ã¨ã¯æ„Ÿè¬ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚

é™ã‚Šã‚ã‚‹è³‡æºã‚’æœ‰åŠ¹æ´»ç”¨ã™ã‚‹ã¨ã„ã†åœ°çƒãƒ¬ãƒ™ãƒ«ã®è¦³ç‚¹ã‹ã‚‰ã®è§£æ±ºç­–ã‚’æ¨¡ç´¢ã—ã¤ã¤ã€è‡ªåˆ†ã«ã§ãã‚‹ã“ã¨ã‚’ã€Œä»Šã™ãã‚„ã‚‹ã€ã¨ã„ã†ã€ã“ã®å§¿å‹¢ã§ç§ã¯ç”Ÿãã¦å‚ã‚ŠãŸã„ã¨æ€ã„ã¾ã™ã€‚ã“ã‚ŒãŒã€ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆğŸ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ :calendar: ã€Œ[ã€Œãƒ¬ã‚¬ã‚·ãƒ¼ã€ã‚’ä¿å®ˆã—ãŸã‚Šã€åˆ·æ–°ã—ãŸã‚Šã™ã‚‹ã«ã‚ãŸã‚Šå¾—ã‚‰ã‚ŒãŸçŸ¥è¦‹ãƒ»ãƒã‚¦ãƒã‚¦ãƒ»è‹¦åŠ´è©± by Works Human Intelligence Advent Calendar 2025](https://qiita.com/advent-calendar/2025/works-hi-2)ã€ã¸ã®ç§ãªã‚Šã®ã‚¢ãƒ³ã‚µãƒ¼ã§ã™ã€‚

ã“ã®ã‚ˆã†ãªå½¢ã§ä»Šå¹´ã‚‚ãã®é€²åŒ–ã‚’ã”å ±å‘Šã§ããŸã“ã¨ã‚’ã†ã‚Œã—ãæ€ã„ã¾ã™ã€‚ãã®æ©Ÿä¼šã‚’ã”æä¾›ãã ã•ã£ãŸã€Works Human Intelligenceã‚µãƒ³ã‚¿ :santa: æ§˜ã¨ @Qiita æ§˜ã«ã¯æ„Ÿè¬ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚

ãã—ã¦ã€å„æ‰€ã§ç§ã®æ‹™ã„AWSã®æˆæ¥­ã‚’å—ã‘ã¦ã„ãŸã ã„ãŸã¿ãªã•ã¾ã«æ„Ÿè¬ã§ã™ã€‚ã‚ˆã‚Šã‚ˆã„æˆæ¥­ã‚’ãŠå±Šã‘ã§ãã‚‹ã‚ˆã†ã«ç²¾é€²ã‚’é‡ã­ã¦å‚ã‚ŠãŸã„ã¨æ€ã„ã¾ã™ã€‚
